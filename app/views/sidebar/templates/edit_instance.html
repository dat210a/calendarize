<div class="edit_event_container" id="editEventForm">
    <form class="editEvent" id="editEvent">
        <div class="row neweventfixedheader accentgrey-dark z-depth-1">
            <div class="col s12">
                <h4 class="left-align grey-text text-lighten-5" id="eventName"></h4>
                <span class="grey-text text-lighten-3" id="year"></span>
            </div>
        </div>
        <button id="btnEditEvent" type="submit" class="btn-floating btn-large waves-effect waves-light right eventdetailsheaderBtn accentgrey-dark"><i class="material-icons">done</i></button>
        <a id="btnCancelEditEvent" onclick="display_event()" class="btn-floating btn-large waves-effect waves-light right eventdetailsheaderBtn cancel accentgrey-dark"><i class="material-icons">close</i></a>
        <div style="padding-top: 5.8em">
            <!--  -->
            <div class="dateHead form-sub-head">
                <div class="row">
                    <h5 style="padding: 0.75rem">Date</h5>
                    <hr>
                </div>
                <div class="row" style="padding-bottom: 0.75rem">
                    <div class="col s4">
                        <p>
                            <input class="with-gap" name="fixedSwitch" type="radio" id="checkFixed" checked />
                            <label for="checkFixed">Fixed</label>
                        </p>
                    </div>
                    <div class="col s8">
                        <p>
                            <input class="with-gap" name="fixedSwitch" type="radio" id="checkNotfixed" />
                            <label for="checkNotfixed">Not Fixed</label>
                        </p>
                    </div>
                </div>
            </div>
            <!--  -->
            <div class="form-sub-body" id="switchFixed">
                <div class="row">
                    <div class="col s12">
                        <label for="startDate">Start date</label>
                        <input id="startDate" Name="startDate" type="text" data-error="Invalid date" class="datepicker" validate required>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                    <label for="endDate">End date</label>
                    <input id="endDate" placeholder="Optional" Name="endDate" type="text" class="datepicker">
                    </div>
                </div>
            </div>
            <!--  -->
            <div class="form-sub-body" id="switchNotfixed">
                <div class="row">
                    <div class="col s7 input-field">
                        <select id="month">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11">December</option>
                        </select>
                        <label>Month</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 input-field">
                        <select id="whenInMonth">
                            <option value="0" selected>Unspecified</option>
                            <option value="1">Beginning</option>
                            <option value="2">Middle</option>
                            <option value="3">End</option>
                        </select>
                        <label>Part of the Month</label>
                    </div>
                </div>
            </div>
            <!--  -->
            <div class="row form-sub-head">
                <h5 style="padding: 0.75rem">Additional information</h5>
                <hr>
            </div>
            <div class="form-sub-body">
                <div class="row">
                    <div class="input-field col s12">
                        <textarea id="textarea1" name="event_details" placeholder="Optional" class="materialize-textarea"></textarea>
                        <label for="textarea1">Notes</label>
                    </div>
                </div>
                <div class="row">
                    <div class="file-field input-field col s12">
                        <div class="btn">
                            <span>File</span>
                            <input type="file" name="file" multiple>
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text" placeholder="Upload one or more files">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    $("#editEventForm").hide(0)

    function fillInData(){
        var child = current_event.children.filter((d) => d.child_year == current_event.year)
        var format = d3.timeFormat('%d %B, %Y')
        if (child.length > 0){
            var child_data = child[0];
            $("#month").val(child_data.child_start.getMonth())
            if (+child_data.child_fixed_date == 0) {
                $("#checkNotfixed").prop('checked', true);
                $("#switchFixed").hide(0)
                $("#switchNotfixed").show(0)
                var start = child_data.child_start.getDate(),
                    end = child_data.child_end.getDate()
                if (start < 5){
                    if (end < 15) $("#whenInMonth").val(1)
                }
                else if (start < 15) $("#whenInMonth").val(2)
                else $("#whenInMonth").val(3)
            }
            else{
                $("#endDate").val(format(child_data.child_end))
            }
            $("#startDate").val(format(child_data.child_start))
            var minDate = new Date(child_data.child_start)
            var maxDate = new Date(child_data.child_start)
        }
        else{
            $("#month").val(current_event.event_start.getMonth())
            if (+current_event.event_fixed_date == 0) {
                $("#checkNotfixed").prop('checked', true);
                $("#switchFixed").hide(0)
                $("#switchNotfixed").show(0)
                var start = current_event.event_start.getDate(),
                    end = current_event.event_end.getDate()
                if (start < 5){
                    if (end < 15) $("#whenInMonth").val(1)
                }
                else if (start < 15) $("#whenInMonth").val(2)
                else $("#whenInMonth").val(3)
            }
            else{
                $("#endDate").val(format(current_event.event_end))
            }
            $("#startDate").val(format(current_event.event_start))
            var minDate = new Date(current_event.event_start)
            var maxDate = new Date(current_event.event_start)
        }
        minDate.setYear(current_event.year - 1)
        maxDate.setYear(current_event.year + 1)
        $('.datepicker').pickadate({
            min: minDate,
            max: maxDate
        })
    }

    // toggle fixed / non fixed date choosers
    $("#switchNotfixed").hide(0)
    $("input[name=fixedSwitch]").change(function(){
        if (this.id == 'checkNotfixed'){
            $("#switchFixed").slideUp('fast', function(){
                $("#switchNotfixed").slideDown('slow')
            })
        }
        else {
            $("#switchNotfixed").slideUp('fast', function(){
                $("#switchFixed").slideDown('slow')
            })
        }
    })

    //minimum end date
    $("#startDate").change(function(){
        var $input = $('#endDate').pickadate()
        var picker = $input.pickadate('picker')
        picker.set('min', $(this).val())
    });

    $(document).ready(function(){
        $("#eventName").text(current_event.event_name)
        $("#year").text("Year: " + current_event.year)
        fillInData();
        init_forms();
        $("#editEventForm").show('slow')
    })

    function prepare_data(form){
        var oData = new FormData($(form)[0]);
        oData.set('event_id', current_event.event_id)
        oData.set('year', current_event.year)
        if ($("#checkFixed").prop( "checked" )){
            oData.set("fixedSwitch", 1)
            oData.set('startDate', new Date(oData.get('startDate')).getTime())
            if (oData.get('endDate') != '') oData.set('endDate', new Date(oData.get('endDate')).getTime())
        }
        else{
            oData.delete("fixedSwitch")
            var startDate = new Date()
            startDate.setFullYear(current_event.year)
            startDate.setMonth($("#month").val())
            startDate.setDate(2)
            startDate.setHours(0, 0, 0, 0)
            var endDate = new Date(startDate)
            endDate.setMonth(endDate.getMonth()+1)
            endDate.setDate(0)
            var numDays = endDate.getDate()-startDate.getDate() + 2
            switch (parseInt($("#whenInMonth").val())){
                case 1:
                endDate.setDate(numDays/3)
                break;
                case 2:
                startDate.setDate(numDays/3+2)
                endDate.setDate(numDays*2/3)
                break;
                case 3:
                startDate.setDate(numDays*2/3+2)
                break;
                default:
                // endDate.setDate(endDate.getDate()+1)
            }
            oData.set('startDate', new Date(startDate).getTime())
            oData.set('endDate', new Date(endDate).getTime())
        }
        return oData;
    }

    $("#editEvent").submit(function(e){
        e.preventDefault()
        formData = prepare_data(this)
        $.ajax({
            url: '/set_instance',
            type: 'POST',
            data: formData,
            encType: "multipart/form-data",
            processData: false,
            contentType: false,
            cache: false,
            success: function(response) {
                r = JSON.parse(response)
                if (r.success == 'true') {
                    $("#sidebar").empty();
                    load_data()
                }
                else {
                    console.log ('Cannot create new event at this time')
                }
            },
            error: function(error) {
                console.log(error);
            }
        });
    });
</script>
